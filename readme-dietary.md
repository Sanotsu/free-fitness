2023-10-26 起来在这里更新 dietary 的进度，避免合并冲突

## 2023-10-26

饮食日记设计思路记录

- 1、直接点击左上角的搜索，则默认是为“早餐”添加食物摄入 item。
  - 如果该日“早餐”已有 item：查询已有的 meal，直接新增 item；如果没有：新增 meal，新增 item。
  - 如果直接在搜索主页面点击添加指定食物，食物摄入 item 的量就是预设的量(就算添加成功，也可以到食物详情页面去修改)
  - 如果搜索到食物之后点击，进入详情页面，可以修改食物份量和单位，然后“保存”或“移除”
    - 如果不添加了，直接返回按钮；移除应该是在主页面直接点击了某一餐的 item 只会跳转的详情页面使用的。
    - 所以显示的按钮：
      - 移除、添加(保存)
- 2、在主页面选中“早中晚夜”各自 tab 的“+”添加按钮，操作和上一步一样，除了对应的餐次。
- 3、可以记录早中晚夜餐次最近的食物及其份量，可以在 meal 表中添加该 meal 属于早中晚夜的哪一顿，或者直接到 meal food item 中新增栏位来标识属于早中晚夜哪一餐的摄入。
  - 或者大改数据库，早中晚夜 4 餐，4 张表，在 daily log 的 4 个栏位分别指定对应其中一个表的数据，关联查询和查询指定内容可能会方便点。
    - 但也只是把 meal 表分成 3 个而已。
  - 如果都不改数据库表的话，查询早中晚夜餐次最近摄入记录的话，直接查询 daily loy 表，指定早中晚夜 meal id，在 date 的最近 7 天能够带出指定 meal 中的那些 meal food item 即可。

基本完成 饮食记录的首页显示以及该日记录和细节栏位的数据库查询函数。

2023-10-27

基本完成 在饮食日记主页面点击“早中晚夜”餐次新增 item 按钮时，跳转到 food list 页面，并在 food list 页面直接添加预设单份食物的值。

删除了一些查询饮食日记的 db helper 方法（因为嵌套太多，这个方法不是很好写，但大体能用，要优化的点还比较多……）

待完成 饮食记录主页面没有日期选择器来指定添加不同日期饮食记录  
待完成 主页面的显示完全没有对应的细节，只是说能找到对应的数据了  
待完成 在 food list 页面只能新增单个，且点击新增、完成新增之后没有返回到主页面，手动返回主页面也没有刷新当日日记的数据。

完全没开始做 进入 foodlist 之后，点击查询结果的食物进入 food detail，然后再修改数量、单位，加入日记餐次列表。

**【日记餐次条目的处理逻辑】**：
-- `2023-10-31 数据库结构改动，此处逻辑完全变化`

- 1、删除：左右滑动即可
- 2、修改：在主页面点击进入详情页，可以修改数量、单位、和 **【餐次】**。
  - 数量和单位还好，直接修改 db 中对应 meal food item 的 food_intake_size 和 serving_info_id 栏位而已；
  - 但是修改餐次就比较麻烦了（**偏向于先不加这个功能，修改餐次直接删除该条目换个餐次新增**）：
    - 首先 要把修改后的 meal food item 添加到新的 meal：
      - 如果新的餐次没有数据：新增 meal 和 item，绑定到 log 对应餐次（因为是修改，当日的 log 一定存在）；
      - 新的餐次有数据：查询 meal 取得 meal id，修改 item 再添加；
    - 其次 要删除旧的餐次的该条 item 数据：
      - 如果删除该 item 之后该餐次还有其他 item，该 item 删除完就完了；
      - 如果删除该 item 之后还餐次没有其他 item，则删除该 meal，再删除该 meal 对应的 log 中的餐次；
- 3、新增：
  - 大概流程：
    - 点击在主页面对应餐次的右侧按钮（或者顶部的搜索按钮，默认为新增到早餐），进入 food list 搜索页面。
    - 在 food list 中再点击需要添加的食物，进入 food detial 页面。
    - 在 food detail 中修改数量、单位、和 **【餐次】**。
  - 问题：
    - 在涉及餐次时和“修改”有点类似，要先查询要移动到的目标餐次有没有数据（没有要移除旧的）
      - 目标餐次有 item，获取该餐次的 meal id 直接新增 item 即可；
      - 目标餐次没有 item，新增 meal，新增 item，
        - 如果连 log 都还没有，还再新增 log，再绑定其餐次的 meal id；
        - 如果有 log，则直接绑定其餐次的 meal id；

条目调到详情页的区分(可用来判断显示不同的按钮)：

- 主页面点击条目 -> 跳转到详情；
- 主页面点击添加 -> 调到食物搜索页面，食物列表选择某一个食物 -> 跳转到详情；

2023-10-30 暂存

pause: log index 和 food list 点击跳转到 food detail 的逻辑有了，但发现了更优的 serving info 的数据库设计，所以暂停目前的内容，修改新的数据库设计。

基本完成: 修改了数据库表 serving_info 的栏位设计，并修改了目前涉及到的所有逻辑部分（主要是 food detail 营养素展示部件）

2023-10-31 暂存

pause：修改旧的某一天某一餐次的条目，需要从早餐移到晚餐非常麻烦，然后重新思考了一下数据库结构，发现被“一天饮食记录只存一条数据”的想法限制住了，所以重新修改数据库，删除原本的 meal 和 meal food item，直接把把一餐的每一个食物摄入留存记录，原本`log-meal-item 1：（4*1）：N` 的设计，直接 `daily_food_item` 一个表搞定，以空间换时间。

注意：巨大结构改动，大量已经完成的功能会被修改

2023-11-01

基本完成：饮食记录数据库结构和栏位的设计，并更新了相关代码
基本完成：log index 添加饮食日记条目，先到 food list，再到 food detail，点击返回后直接回到 log index，并刷新 log index 页面

- 注意：这里参考了 stackoverflow 的 [Flutter - Pass Data Back with .popUntil](https://stackoverflow.com/questions/52075130/flutter-pass-data-back-with-popuntil) 想 popUntil 时带上参数进行刷新，但是没有成功，获取不到返回的数据。
  - popUntil 带返回值的需求一直有，但没有提供，参看[issue](https://github.com/flutter/flutter/issues/30112)。
  - 目前返回上上层并刷新其页面的实现最简单如下(都不用使用命名路由)：
  ```dart
  Navigator.of(context)
        ..pop()
        ..pop(true);
  Navigator.of(context).pushReplacement(
        MaterialPageRoute(builder: (_) => const DietaryRecords()),
      );
  ```

2023-11-02

基本完成：log index 滑动移除饮食日记条目，log index 点击 item 进入 food detail 中移除条目。

待完成：新增食物和食物单份营养素的表单页面

待完成：饮食记录主页的日期选择器

- 基本完成 2023-11-02
- 【存在问题】，切换了日期再进入 food list 或者 food detail 之后返回主页面，日期会被重置为今天，因为是整个重新加载部件而不是指定更新状态。
  - 无法 setstate 是因为跨级返回时(log index - food list - food detail 返回)无法带参数，这个找办法。

待完成：饮食记录主页的显示，和饮食数据的多种展示方式（精简、具体……）

待完成：导出饮食记录(这个功能靠后)

考虑：一个导入表格或者 json 文件的接口，一次性导入多个食物及其各项单份营养素信息
